<div class="page">
  <header class="page-header">
    <div>
      <div class="header-top-line">
        <span class="header-dot"></span>
        <span>RentalAI Copilot ‚Ä¢ Beta</span>
      </div>
      <h1 class="page-title">
        <span>RentalAI Copilot</span>
      </h1>
      <p class="page-subtitle">
        Paste a renter request and let the copilot infer items, apply tier policies, and compute totals ‚Äî
        just like a CSR would.
      </p>
    </div>
    <p class="header-tagline">
      Runs entirely in this demo environment. Model decisions and line items are logged for review.
    </p>
  </header>

  <main class="layout">
    <!-- LEFT: FORM -->
    <section class="card">
      <h2>Create Draft Quote</h2>
      <p class="card-subtitle">
        Fill in the renter details and let the copilot build the quote.
      </p>

      <form class="form-section" (ngSubmit)="onSubmit()" #quoteForm="ngForm">
        <!-- Renter request -->
        <div>
          <label class="field-label">Renter request</label>
          <textarea
            class="textarea"
            [(ngModel)]="form.request_text"
            name="request_text"
            placeholder="Example: We need 30 chairs and 5 round tables for a weekend event in Dallas."
            required
          ></textarea>
        </div>

        <!-- Tier / Location / Seed -->
        <div class="form-row-3">
          <div>
            <label class="field-label">Tier</label>
            <select
              class="select"
              [(ngModel)]="form.customer_tier"
              name="customer_tier"
            >
              <option value="A">A ‚Äì Top</option>
              <option value="B">B ‚Äì Standard</option>
              <option value="C">C ‚Äì Budget</option>
            </select>
          </div>

          <div>
            <label class="field-label">Location (city)</label>
            <input
              class="input"
              [(ngModel)]="form.location"
              name="location"
              placeholder="Dallas"
            />
          </div>

          <div>
            <label class="field-label">Seed (optional)</label>
            <input
              class="input"
              [(ngModel)]="form.seed"
              name="seed"
              type="number"
              placeholder="e.g. 1"
            />
          </div>
        </div>

        <!-- Dates + ZIP -->
        <div class="form-row-3">
          <div>
            <label class="field-label">Start date</label>
            <input
              class="input"
              [(ngModel)]="form.start_date"
              name="start_date"
              type="date"
            />
          </div>
          <div>
            <label class="field-label">End date</label>
            <input
              class="input"
              [(ngModel)]="form.end_date"
              name="end_date"
              type="date"
            />
          </div>
          <div>
            <label class="field-label">ZIP</label>
            <input
              class="input"
              [(ngModel)]="form.zip"
              name="zip"
              placeholder="75201"
            />
          </div>
        </div>

        <!-- Buttons + hint -->
        <div class="btn-row">
          <button
            type="submit"
            class="btn-primary"
            [disabled]="loading || !quoteForm.form.valid"
          >
            <span *ngIf="!loading">Generate Quote</span>
            <span *ngIf="loading">
              <span class="spinner"></span> Running‚Ä¶
            </span>
          </button>

          <button type="button" class="btn-secondary" (click)="onClear()">
            Clear
          </button>

          <span class="form-hint">
            Model decisions and line items are logged for review in this demo.
          </span>
        </div>

        <p *ngIf="error" class="error-text">
          {{ error }}
        </p>
      </form>
    </section>

    <!-- RIGHT: PREVIEW -->
    <section class="card">
      <h2>Quote Preview</h2>
      <p class="card-subtitle">
        Generated from the renter request in real time.
      </p>

      <!-- Empty state -->
      <div
        *ngIf="!result && !loading && !error"
        class="preview-empty"
      >
        <div class="empty-icon">‚ú®</div>
        <div class="empty-title">Ready to generate a quote</div>
        <div class="empty-message">
          Enter a customer request on the left and click <strong>Generate Quote</strong>
          to see itemized pricing, fees, and AI recommendations.
        </div>
        <div class="empty-example">
          <div class="example-label">Example request:</div>
          <div class="example-text">
            "Need 50 chairs and 5 tables for a weekend wedding in Dallas"
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div *ngIf="loading" class="preview-loading">
        <div class="loading-spinner-large"></div>
        <div class="loading-title">Generating your quote...</div>
        <div class="loading-steps">
          <div class="loading-step active">
            <span class="step-icon">‚úì</span>
            <span>Analyzing request</span>
          </div>
          <div class="loading-step active">
            <span class="step-icon">‚è≥</span>
            <span>Finding inventory items</span>
          </div>
          <div class="loading-step">
            <span class="step-icon">‚è≥</span>
            <span>Applying pricing policies</span>
          </div>
        </div>
      </div>

      <!-- Error -->
      <div *ngIf="error && !loading" class="preview-error">
        <div class="error-icon">üòï</div>
        <div class="error-title">Unable to generate quote</div>
        <div class="error-message">{{ error }}</div>
        <div class="error-suggestions">
          <div class="error-suggestions-title">Common issues:</div>
          <ul class="error-suggestions-list">
            <li>Check backend is running</li>
            <li>Verify request has details</li>
            <li>Try a simpler request</li>
          </ul>
        </div>
        <button class="btn-retry" (click)="onSubmit()">Try Again</button>
      </div>

      <!-- Result -->
      <ng-container *ngIf="result?.quote as q">
        <!-- Prominent Total Card -->
        <div class="quote-total-card">
          <div class="total-card-header">
            <span class="total-badge">QUOTE TOTAL</span>
            <span class="tier-badge">Tier {{ form.customer_tier || 'C' }}</span>
          </div>

          <div class="total-amount">
            ${{ q.total || 0 | number : '1.2-2' }}
          </div>

          <div class="total-breakdown">
            <div class="breakdown-row">
              <span>Subtotal</span>
              <span>${{ q.subtotal || 0 | number : '1.2-2' }}</span>
            </div>
            <div class="breakdown-row">
              <span>Fees</span>
              <span>${{ calculateFees(q.fees) | number : '1.2-2' }}</span>
            </div>
            <div class="breakdown-row">
              <span>Tax (8.25%)</span>
              <span>${{ q.tax || 0 | number : '1.2-2' }}</span>
            </div>
          </div>

          <div class="total-location" *ngIf="form.location">
            <span>üìç</span>
            <span>{{ form.location }}</span>
          </div>
        </div>

        <!-- Items Section -->
        <div *ngIf="q.items?.length">
          <div class="section-header">
            <span class="section-icon">üìã</span>
            <span>LINE ITEMS ({{ q.items.length }} items)</span>
          </div>
          <table class="items-table">
            <thead>
              <tr>
                <th>Item</th>
                <th style="text-align: right;">Qty</th>
                <th style="text-align: right;">Unit</th>
                <th style="text-align: right;">Total</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of q.items; let i = index" [class.row-even]="i % 2 === 1">
                <td>
                  <div class="item-name">{{ item.name }}</div>
                  <div *ngIf="item.sku" class="item-sku">
                    SKU: {{ item.sku }}
                  </div>
                </td>
                <td style="text-align: right;">
                  {{ item.qty }}
                </td>
                <td style="text-align: right;">
                  ${{ item.unitPrice | number : '1.2-2' }}
                </td>
                <td style="text-align: right;">
                  ${{ item.subtotal | number : '1.2-2' }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Fees Section -->
        <div *ngIf="q.fees?.length" class="fees-section">
          <div class="section-header">
            <span class="section-icon">üíµ</span>
            <span>FEES & ADJUSTMENTS</span>
          </div>
          <div class="fees-list">
            <div *ngFor="let f of q.fees" class="fee-row">
              <span class="fee-name">{{ f.name }}</span>
              <span class="fee-amount">${{ f.amount | number : '1.2-2' }}</span>
            </div>
          </div>
        </div>

        <!-- AI Notes Section -->
        <div *ngIf="result?.notes" class="ai-notes-section">
          <div class="ai-notes-header">
            <span class="ai-icon">ü§ñ</span>
            <span>AI COPILOT NOTES</span>
          </div>
          <div class="ai-notes-content">
            {{ result.notes }}
          </div>
        </div>
      </ng-container>
    </section>
  </main>
</div>
