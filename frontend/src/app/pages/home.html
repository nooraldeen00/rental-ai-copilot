<div class="page">
  <header class="page-header">
    <div>
      <div class="header-top-line">
        <span class="header-dot"></span>
        <span>Enterprise Quoting Intelligence Platform</span>
        <select
          class="lang-select"
          [(ngModel)]="langService.selectedLanguage"
          name="globalLanguage">
          <option *ngFor="let lang of langService.languages" [value]="lang.code">
            {{ lang.flag }} {{ lang.label }}
          </option>
        </select>
        <span class="verified-badge">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10.5 3L4.5 9L1.5 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          VERIFIED PLATFORM
        </span>
      </div>
      <h1 class="page-title">
        <span>RentalAI</span> Copilot
      </h1>
      <p class="page-subtitle">
        The industry's most advanced quoting engine for professional rental operations. Leveraging enterprise-grade AI to interpret customer requirements, execute complex pricing logic, and deliver precise quotes with institutional accuracy.
      </p>
    </div>
    <div class="header-footer">
      <p class="header-tagline">
        Trusted by professional rental operations nationwide ‚Ä¢ Real-time pricing intelligence ‚Ä¢ Zero-error quote generation
      </p>
      <div class="security-badges">
        <span class="security-badge">üîí Enterprise Security</span>
        <span class="security-badge">‚úì SOC 2 Compliant</span>
        <span class="security-badge">‚ö° 99.9% Uptime SLA</span>
      </div>
    </div>
  </header>

  <main class="layout">
    <!-- LEFT: FORM -->
    <section class="card">
      <h2>Quote Request Configuration</h2>
      <p class="card-subtitle">
        Enter customer requirements below. Our AI engine will instantly parse equipment needs, execute tier-based pricing logic, and generate a professional quote ready for customer delivery.
      </p>

      <form class="form-section" (ngSubmit)="onSubmit()" #quoteForm="ngForm">
        <!-- Renter request -->
        <div>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
            <label class="field-label" style="margin-bottom: 0;">Customer Requirements</label>
            <button
              type="button"
              class="btn-speak"
              (click)="toggleSpeechRecognition()"
              [class.listening]="isListening"
              [disabled]="!speechSupported"
              [title]="!speechSupported ? 'Speech not supported' : (isListening ? 'Stop listening' : 'Speak your request')">
              {{ isListening ? 'üé§ Listening...' : 'üé§ Speak' }}
            </button>
          </div>
          <textarea
            class="textarea"
            [(ngModel)]="form.request_text"
            name="request_text"
            [placeholder]="isListening ? 'Speak now...' : 'Example: Need 50 white folding chairs and 5 60-inch round tables for corporate event, Friday through Sunday delivery in Dallas metro area. Tier B account.'"
            required
          ></textarea>
        </div>

        <!-- Tier / Location / Seed -->
        <div class="form-row-3">
          <div>
            <label class="field-label">Customer Tier</label>
            <select
              class="select"
              [(ngModel)]="form.customer_tier"
              name="customer_tier"
            >
              <option value="A">Tier A ‚Äî Premium Account (15% discount)</option>
              <option value="B">Tier B ‚Äî Corporate Account (5% discount)</option>
              <option value="C">Tier C ‚Äî Standard Account</option>
            </select>
          </div>

          <div>
            <label class="field-label">Service Location</label>
            <select
              class="select"
              [(ngModel)]="form.selectedServiceLocationId"
              name="selectedServiceLocationId"
            >
              <option value="">-- Select Location --</option>
              <option value="plano-tx">Plano, TX</option>
              <option value="dallas-tx">Dallas, TX</option>
              <option value="fort-worth-tx">Fort Worth, TX</option>
              <option value="arlington-tx">Arlington, TX</option>
              <option value="southlake-tx">Southlake, TX</option>
            </select>
          </div>

          <div>
            <label class="field-label">Quote ID (optional)</label>
            <input
              class="input"
              [(ngModel)]="form.seed"
              name="seed"
              type="number"
              placeholder="Auto-generated"
            />
          </div>
        </div>

        <!-- Dates + ZIP -->
        <div class="form-row-3">
          <div>
            <label class="field-label">Rental Start</label>
            <input
              class="input"
              [(ngModel)]="form.start_date"
              name="start_date"
              type="date"
            />
          </div>
          <div>
            <label class="field-label">Rental End</label>
            <input
              class="input"
              [(ngModel)]="form.end_date"
              name="end_date"
              type="date"
            />
          </div>
          <div>
            <label class="field-label">Postal Code</label>
            <input
              class="input"
              [(ngModel)]="form.zip"
              name="zip"
              placeholder="75201"
            />
          </div>
        </div>

        <!-- Buttons + hint -->
        <div class="btn-row">
          <button
            type="submit"
            class="btn-primary"
            [disabled]="loading || !quoteForm.form.valid"
          >
            <span *ngIf="!loading">Generate Professional Quote</span>
            <span *ngIf="loading">
              <span class="spinner"></span> Processing‚Ä¶
            </span>
          </button>

          <button type="button" class="btn-secondary" (click)="onClear()">
            Reset Form
          </button>

          <button type="button" class="btn-browse" (click)="openInventoryBrowser()">
            What Can I Rent?
          </button>

          <span class="form-hint">
            Enterprise AI engine ‚Ä¢ Institutional pricing accuracy ‚Ä¢ Instant quote delivery
          </span>
        </div>

        <p *ngIf="error" class="error-text">
          {{ error }}
        </p>
      </form>
    </section>

    <!-- RIGHT: PREVIEW -->
    <section class="card">
      <h2>Quote Output</h2>
      <p class="card-subtitle">
        Precision-engineered pricing with automated tier discount application and intelligent inventory allocation. Quote-ready for customer delivery.
      </p>

      <!-- Empty state -->
      <div
        *ngIf="!result && !loading && !error"
        class="preview-empty"
      >
        <div class="empty-icon">‚ö°</div>
        <div class="empty-title">Quote Engine Initialized</div>
        <div class="empty-message">
          Professional quoting infrastructure ready. Enter customer requirements to generate institutional-grade quotes with automated pricing intelligence, tier-based discount execution, and equipment allocation logic.
        </div>
        <div class="empty-example">
          <div class="example-label">Example request:</div>
          <div class="example-text">
            "50 white folding chairs and 5 60-inch round tables, Friday through Sunday delivery, Dallas metro area, corporate account"
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div *ngIf="loading" class="preview-loading">
        <div class="loading-spinner-large"></div>
        <div class="loading-title">Quote Engine Processing</div>
        <div class="loading-steps">
          <div class="loading-step active">
            <span class="step-icon">‚úì</span>
            <span>Parsing customer requirements</span>
          </div>
          <div class="loading-step active">
            <span class="step-icon">‚è≥</span>
            <span>Executing inventory allocation logic</span>
          </div>
          <div class="loading-step">
            <span class="step-icon">‚è≥</span>
            <span>Applying pricing intelligence & tier discounts</span>
          </div>
        </div>
      </div>

      <!-- Error -->
      <div *ngIf="error && !loading" class="preview-error">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-title">Quote Engine Unavailable</div>
        <div class="error-message">{{ error }}</div>
        <div class="error-suggestions">
          <div class="error-suggestions-title">Diagnostic steps:</div>
          <ul class="error-suggestions-list">
            <li>Verify quote engine service is operational</li>
            <li>Confirm customer requirements include equipment specifications</li>
            <li>Validate network connectivity to backend infrastructure</li>
          </ul>
        </div>
        <button class="btn-retry" (click)="onSubmit()">Retry Request</button>
      </div>

      <!-- Result -->
      <ng-container *ngIf="result?.quote as q">
        <!-- Action Buttons for PDF and Voice -->
        <div class="btn-row" style="margin-bottom: 1rem;">
          <button
            class="btn-pdf"
            (click)="onDownloadPdf()"
            [disabled]="downloadingPdf"
            type="button">
            <span *ngIf="!downloadingPdf">Download PDF Quote</span>
            <span *ngIf="downloadingPdf">
              <span class="spinner"></span> Generating PDF...
            </span>
          </button>

          <button
            class="btn-voice"
            (click)="onPlaySummary()"
            [disabled]="!ttsSupported || !q.notes?.length"
            [class.speaking]="isSpeaking"
            [class.loading]="ttsLoading"
            type="button"
            [title]="ttsSupported ? 'Read AI notes aloud (ElevenLabs)' : 'Text-to-speech not supported'">
            <span *ngIf="ttsLoading">
              <span class="spinner"></span> Loading...
            </span>
            <span *ngIf="!ttsLoading && !isSpeaking">Play Summary</span>
            <span *ngIf="!ttsLoading && isSpeaking">Stop</span>
          </button>
        </div>

        <!-- PDF Error -->
        <div *ngIf="pdfError" class="alert-warning">{{ pdfError }}</div>

        <!-- TTS Error -->
        <div *ngIf="ttsError" class="alert-warning">{{ ttsError }}</div>

        <!-- Location Conflict Warning -->
        <div *ngIf="q.resolved_location?.location_conflict" class="alert-location-conflict">
          <span class="conflict-icon">‚ö†Ô∏è</span>
          <span class="conflict-message">{{ q.resolved_location?.conflict_message }}</span>
        </div>

        <!-- Prominent Total Card -->
        <div class="quote-total-card">
          <div class="total-card-header">
            <span class="total-badge">QUOTE TOTAL</span>
            <span class="tier-badge">Tier {{ form.customer_tier || 'C' }}</span>
          </div>

          <div class="total-amount">
            ${{ q.total || 0 | number : '1.2-2' }}
          </div>

          <div class="total-breakdown">
            <div class="breakdown-row">
              <span>Subtotal</span>
              <span>${{ q.subtotal || 0 | number : '1.2-2' }}</span>
            </div>
            <div class="breakdown-row">
              <span>Fees</span>
              <span>${{ calculateFees(q.fees) | number : '1.2-2' }}</span>
            </div>
            <div class="breakdown-row">
              <span>Tax (8.25%)</span>
              <span>${{ q.tax || 0 | number : '1.2-2' }}</span>
            </div>
          </div>

          <div class="total-location" *ngIf="q.resolved_location?.location_final">
            <span>üìç</span>
            <span>{{ q.resolved_location.location_final }}</span>
            <span *ngIf="q.resolved_location.location_conflict" class="location-conflict-badge">‚ö†Ô∏è Please confirm</span>
          </div>
        </div>

        <!-- Items Section -->
        <div *ngIf="q.items?.length">
          <div class="section-header">
            <span class="section-icon">üìã</span>
            <span>EQUIPMENT ALLOCATION ({{ q.items.length }} items)</span>
          </div>
          <table class="items-table">
            <thead>
              <tr>
                <th>Item</th>
                <th style="text-align: center;">Qty</th>
                <th style="text-align: center;">Days</th>
                <th style="text-align: right;">Daily Rate</th>
                <th style="text-align: right;">Line Total</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of q.items; let i = index" [class.row-even]="i % 2 === 1">
                <td>
                  <div class="item-name">{{ item.name }}</div>
                  <div *ngIf="item.sku" class="item-sku">
                    SKU: {{ item.sku }}
                  </div>
                </td>
                <td style="text-align: center;">
                  {{ item.qty }}
                </td>
                <td style="text-align: center;">
                  {{ item.days || 1 }}
                </td>
                <td style="text-align: right;">
                  ${{ item.dailyRate || item.unitPrice | number : '1.2-2' }}
                </td>
                <td style="text-align: right;">
                  ${{ item.subtotal | number : '1.2-2' }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Fees Section -->
        <div *ngIf="q.fees?.length" class="fees-section">
          <div class="section-header">
            <span class="section-icon">üíµ</span>
            <span>ADDITIONAL CHARGES</span>
          </div>
          <div class="fees-list">
            <div *ngFor="let f of q.fees" class="fee-row">
              <span class="fee-name">{{ f.name }}</span>
              <span class="fee-amount">${{ f.amount | number : '1.2-2' }}</span>
            </div>
          </div>
        </div>

        <!-- AI Notes Section -->
        <div *ngIf="q.notes && q.notes.length" class="ai-notes-section">
          <div class="ai-notes-header">
            <span class="ai-icon">ü§ñ</span>
            <span>QUOTE INTELLIGENCE SUMMARY</span>
          </div>
          <div class="ai-notes-content">
            <ul class="ai-notes-list">
              <li *ngFor="let note of q.notes">{{ note }}</li>
            </ul>
          </div>
        </div>

        <!-- Terms & Conditions Section -->
        <div class="terms-section">
          <div class="terms-header">
            <span class="terms-icon">üìú</span>
            <span>TERMS & CONDITIONS</span>
          </div>
          <div class="terms-content">
            <ol class="terms-list">
              <li><strong>Quote Validity:</strong> This quote is valid for 30 days from the date of issuance unless otherwise specified.</li>
              <li><strong>Reservation & Deposit:</strong> A 25% non-refundable deposit is required to confirm your reservation. Balance is due upon delivery.</li>
              <li><strong>Cancellation Policy:</strong> Cancellations made 7+ days prior to rental date receive a full refund of deposit. Cancellations within 7 days forfeit the deposit.</li>
              <li><strong>Delivery & Pickup:</strong> Delivery and pickup times are estimates. Customer must provide clear access to delivery location. Additional charges may apply for stairs, long carries, or difficult access.</li>
              <li><strong>Equipment Condition:</strong> Customer is responsible for equipment from delivery to pickup. Damaged, lost, or stolen items will be charged at replacement cost.</li>
              <li><strong>Damage Waiver:</strong> Optional damage waiver covers normal wear and accidental damage up to $1,000 per item. Intentional damage, theft, and negligence are not covered.</li>
              <li><strong>Setup & Breakdown:</strong> Basic delivery includes drop-off only. Setup and breakdown services available at additional cost upon request.</li>
              <li><strong>Weather Policy:</strong> Customer assumes responsibility for weather-related decisions. Tents and outdoor equipment should be secured per manufacturer guidelines.</li>
              <li><strong>Extension Policy:</strong> Rental extensions must be requested 24 hours in advance and are subject to availability. Late returns incur a 1.5x daily rate.</li>
              <li><strong>Liability:</strong> Customer agrees to indemnify and hold harmless the rental company from any claims arising from equipment use.</li>
            </ol>
            <div class="terms-footer">
              <p>By proceeding with this quote, customer acknowledges and agrees to the above terms and conditions.</p>
              <p class="terms-contact">Questions? Contact us at <strong>rentals@example.com</strong> or <strong>(214) 555-0100</strong></p>
            </div>
          </div>
        </div>
      </ng-container>
    </section>
  </main>
</div>

<!-- Inventory Browser Modal -->
<app-inventory-browser
  *ngIf="showInventoryBrowser"
  (closeModal)="closeInventoryBrowser()">
</app-inventory-browser>
